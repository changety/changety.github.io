
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Fresco图片解码部分源码分析及webp vs jpeg指标对比 - Bian&#8217;s blog</title>
	<meta name="author" content="BianYuting">

	
	<meta name="description" content="Fresco图片解码部分源码分析及webp vs Jpeg指标对比 前言 之前的文章写过webp图片的调研，这篇分析一下fresco的decoder部分的源码，同时从响应、下载、解码、大小四个指标上对比同一张图片的webp 与jpg格式。这里响应时间应该与图片格式本身没有关系， &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Bian's blog" type="application/atom+xml">
	
	<link rel="canonical" href="http://changety.github.io/blog/2017/06/20/fresco-jpg-webp-decode/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="	http://cdn.staticfile.org/jquery/1.7.2/jquery.min.js"></script>
	<link href="/stylesheets/google-fonts.css" rel="stylesheet" type="text/css">
	
</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		document.write("<img alt='Profile Picture' src='/images/avatar.png' style='width:160px;'/>");
	</script>
</div>
<h1><a href="/">Bian&#8217;s blog</a></h1>
<p class="subtitle">as a time machine</p>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Home</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/aboutme">About</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		<a class="weibo" href="http://www.weibo.com/changety" title="Weibo">Weibo</a>
		
		
		
		
		
		<a class="github" href="https://github.com/changety" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
<p class="description">be the change you want to see in the world</p>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Fresco图片解码部分源码分析及webp vs Jpeg指标对比</h1>
	<div class="entry-content" itemprop="articleBody"><h1>前言</h1>

<h2><em>之前的文章写过<a href="http://changety.github.io/blog/2016/01/31/webp-research/">webp图片的调研</a>，这篇分析一下fresco的decoder部分的源码，同时从响应、下载、解码、大小四个指标上对比同一张图片的webp 与jpg格式。这里响应时间应该与图片格式本身没有关系，但这里为了对服务器接口做一个测试也加入了对比；下载时间应该与图片size成正相关，这里也加入对比，看看结果是否符合预期。根据google官网介绍，目前WebP与JPG相比较，编解码速度上，毫秒级别上：编码速度webp比jpg慢10倍，解码速度慢1.5倍。在我们的使用场景下，编码速度的影响可以被忽略，因为服务器会在用户第一次请求时，编码生成jpg图片对应的webp图片，之后都会被缓存下来，可以认为几乎所有用户的请求都能命中缓存。解码方面，则是每个用户拿到webp图片都必经的开销，因此解码速度是本次测试对比的关键指标。</em></h2>

<h1>Fresco WebP支持</h1>

<p>我们的客户端使用的是<a href="https://github.com/facebook/fresco">fresco</a>图片库，根据其<a href="http://frescolib.org/docs/webp-support.html#main_wrap">官方文档说明</a>：</p>

<blockquote><p>Android added webp support in version 4.0 and improved it in 4.2.1:
4.0+ (Ice Cream Sandwich): basic webp support
4.2.1+ (Jelly Beam MR1): support for transparency and losless wepb
Fresco handles webp images by default if the OS supports it. So you can use webp with 4.0+ and trasparency and losless webps from 4.2.1.
Fresco also supports webp for older OS versions. The only thing you need to do is add thewebpsupportlibrary to your dependencies. So if you want to use webps on Gingerbread just add the following line to your gradle build file:
<em>compile &lsquo;com.facebook.fresco:webpsupport:1.3.0&rsquo;</em></p></blockquote>

<p>因此我们需要引入webpsupprot库，这样子fresco会处理对webp的支持。下面也会从源码上分析，fresco是如何解码webp的。</p>

<h1>Fresco Producer源码分析</h1>

<h2>Producer继承结构</h2>

<p>首先我们看一下Frecso中Producer的继承结构图：</p>

<div align=center>
<img src="http://upload-images.jianshu.io/upload_images/76332-66b1c9b26eb0033d.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" width="600" height="600" alt="fresco producer继承关系"/>
</div>


<h2>Producer流水线</h2>

<p><code>ProducerSequenceFactory</code>是专门将生成各类链接起来的Producer，根据其中的逻辑，这里将可能涉及层次最深的Uri——网络Uri的Producer链在此列出，它会到每个缓存中查找数据，最后如果都没有命中，则会去网络上下载。</p>

<table>
<thead>
<tr>
<th style="text-align:center;">顺序</th>
<th style="text-align:center;">Producer</th>
<th style="text-align:center;">是否必须</th>
<th style="text-align:left;">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">1</td>
<td style="text-align:center;">PostprocessedBitmapMemoryCacheProducer</td>
<td style="text-align:center;">否</td>
<td style="text-align:left;">在Bitmap缓存中查找被PostProcess过的数据</td>
</tr>
<tr>
<td style="text-align:center;">2</td>
<td style="text-align:center;">PostprocessorProducer</td>
<td style="text-align:center;">否</td>
<td style="text-align:left;">对下层Producer传上来的数据进行PostProcess</td>
</tr>
<tr>
<td style="text-align:center;">3</td>
<td style="text-align:center;">BitmapMemoryCacheGetProducer</td>
<td style="text-align:center;">是</td>
<td style="text-align:left;">使Producer序列只读</td>
</tr>
<tr>
<td style="text-align:center;">4</td>
<td style="text-align:center;">ThreadHandoffProducer</td>
<td style="text-align:center;">是</td>
<td style="text-align:left;">使下层Producer工作在后台进程中执行</td>
</tr>
<tr>
<td style="text-align:center;">5</td>
<td style="text-align:center;">BitmapMemoryCacheKeyMultiplexProducer</td>
<td style="text-align:center;">是</td>
<td style="text-align:left;">使多个相同已解码内存缓存键的ImageRequest都从相同Producer中获取数据</td>
</tr>
<tr>
<td style="text-align:center;">6</td>
<td style="text-align:center;">BitmapMemoryCacheProducer</td>
<td style="text-align:center;">是</td>
<td style="text-align:left;">从已解码的内存缓存中获取数据</td>
</tr>
<tr>
<td style="text-align:center;">7</td>
<td style="text-align:center;"><strong>DecodeProducer</strong></td>
<td style="text-align:center;">是</td>
<td style="text-align:left;">将下层Producer产生的数据解码</td>
</tr>
<tr>
<td style="text-align:center;">8</td>
<td style="text-align:center;">ResizeAndRotateProducer</td>
<td style="text-align:center;">否</td>
<td style="text-align:left;">将下层Producer产生的数据变换</td>
</tr>
<tr>
<td style="text-align:center;">9</td>
<td style="text-align:center;">EncodedCacheKeyMultiplexProducer</td>
<td style="text-align:center;">是</td>
<td style="text-align:left;">使多个相同未解码内存缓存键的ImageRequest都从相同Producer中获取数据</td>
</tr>
<tr>
<td style="text-align:center;">10</td>
<td style="text-align:center;">EncodedMemoryCacheProducer</td>
<td style="text-align:center;">是</td>
<td style="text-align:left;">从未解码的内存缓存中获取数据</td>
</tr>
<tr>
<td style="text-align:center;">11</td>
<td style="text-align:center;">DiskCacheProducer</td>
<td style="text-align:center;">是</td>
<td style="text-align:left;">从文件缓存中获取数据</td>
</tr>
<tr>
<td style="text-align:center;">12</td>
<td style="text-align:center;">WebpTranscodeProducer</td>
<td style="text-align:center;">否</td>
<td style="text-align:left;">Transcodes WebP to JPEG / PNG</td>
</tr>
<tr>
<td style="text-align:center;">13</td>
<td style="text-align:center;"><strong>NetworkFetchProducer</strong></td>
<td style="text-align:center;">是</td>
<td style="text-align:left;">从网络上获取数据</td>
</tr>
</tbody>
</table>


<hr />

<p>为了获得每一张网络图片的大小、响应时间、下载时间、decode时间，我们需要探索Fresco的源码，挂上钩子去得到这些指标；这里我们关心<code>DecoderProducer</code>、<code>NetworkFetchProducer</code>，顾名思义，这两个Producer分别用于解码和网络加载相关。</p>

<h3>DecodeProducer解码过程</h3>

<p>DecodeProducer负责将未解码的数据生产出解码的数据。先看produceResults方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">produceResults</span><span class="o">(</span><span class="kd">final</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">CloseableReference</span><span class="o">&lt;</span><span class="n">CloseableImage</span><span class="o">&gt;&gt;</span> <span class="n">consumer</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ProducerContext</span> <span class="n">producerContext</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">ImageRequest</span> <span class="n">imageRequest</span> <span class="o">=</span> <span class="n">producerContext</span><span class="o">.</span><span class="na">getImageRequest</span><span class="o">();</span>
</span><span class='line'>    <span class="n">ProgressiveDecoder</span> <span class="n">progressiveDecoder</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(!</span><span class="n">UriUtil</span><span class="o">.</span><span class="na">isNetworkUri</span><span class="o">(</span><span class="n">imageRequest</span><span class="o">.</span><span class="na">getSourceUri</span><span class="o">()))</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">progressiveDecoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">LocalImagesProgressiveDecoder</span><span class="o">(</span><span class="n">consumer</span><span class="o">,</span> <span class="n">producerContext</span><span class="o">,</span> <span class="n">mDecodeCancellationEnabled</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">ProgressiveJpegParser</span> <span class="n">jpegParser</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ProgressiveJpegParser</span><span class="o">(</span><span class="n">mByteArrayPool</span><span class="o">);</span>
</span><span class='line'>      <span class="n">progressiveDecoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">NetworkImagesProgressiveDecoder</span><span class="o">(</span><span class="n">consumer</span><span class="o">,</span> <span class="n">producerContext</span><span class="o">,</span> <span class="n">jpegParser</span><span class="o">,</span> <span class="n">mProgressiveJpegConfig</span><span class="o">,</span> <span class="n">mDecodeCancellationEnabled</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">mInputProducer</span><span class="o">.</span><span class="na">produceResults</span><span class="o">(</span><span class="n">progressiveDecoder</span><span class="o">,</span> <span class="n">producerContext</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过判断uri的类型 选择不同的渐近式解释器，local和network都继承自ProgressiveDecoder</p>

<p>在<code>ProgressiveDecoder</code>的构造方法中，doDecode(encodedImage, isLast) 进行解析。而真正解析的则是<code>ImageDecode</code>r#decodeImage方法，这个方法将encodedImage解析成<code>CloseableImage</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/** Performs the decode synchronously. */</span>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doDecode</span><span class="o">(</span><span class="n">EncodedImage</span> <span class="n">encodedImage</span><span class="o">,</span> <span class="nd">@Status</span> <span class="kt">int</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">isFinished</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">EncodedImage</span><span class="o">.</span><span class="na">isValid</span><span class="o">(</span><span class="n">encodedImage</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">final</span> <span class="n">String</span> <span class="n">imageFormatStr</span><span class="o">;</span>
</span><span class='line'>  <span class="n">ImageFormat</span> <span class="n">imageFormat</span> <span class="o">=</span> <span class="n">encodedImage</span><span class="o">.</span><span class="na">getImageFormat</span><span class="o">();</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">imageFormat</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">imageFormatStr</span> <span class="o">=</span> <span class="n">imageFormat</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">imageFormatStr</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">final</span> <span class="n">String</span> <span class="n">encodedImageSize</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">final</span> <span class="n">String</span> <span class="n">sampleSize</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isLast</span> <span class="o">=</span> <span class="n">isLast</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isLastAndComplete</span> <span class="o">=</span> <span class="n">isLast</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">statusHasFlag</span><span class="o">(</span><span class="n">status</span><span class="o">,</span> <span class="n">IS_PARTIAL_RESULT</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isPlaceholder</span> <span class="o">=</span> <span class="n">statusHasFlag</span><span class="o">(</span><span class="n">status</span><span class="o">,</span> <span class="n">IS_PLACEHOLDER</span><span class="o">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">encodedImage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">encodedImageSize</span> <span class="o">=</span> <span class="n">encodedImage</span><span class="o">.</span><span class="na">getWidth</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;x&quot;</span> <span class="o">+</span> <span class="n">encodedImage</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span>
</span><span class='line'>    <span class="n">sampleSize</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">encodedImage</span><span class="o">.</span><span class="na">getSampleSize</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// We should never be here</span>
</span><span class='line'>    <span class="n">encodedImageSize</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="n">sampleSize</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="kd">final</span> <span class="n">String</span> <span class="n">requestedSizeStr</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">final</span> <span class="n">ResizeOptions</span> <span class="n">resizeOptions</span> <span class="o">=</span> <span class="n">mProducerContext</span><span class="o">.</span><span class="na">getImageRequest</span><span class="o">().</span><span class="na">getResizeOptions</span><span class="o">();</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">resizeOptions</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">requestedSizeStr</span> <span class="o">=</span> <span class="n">resizeOptions</span><span class="o">.</span><span class="na">width</span> <span class="o">+</span> <span class="s">&quot;x&quot;</span> <span class="o">+</span> <span class="n">resizeOptions</span><span class="o">.</span><span class="na">height</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">requestedSizeStr</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">long</span> <span class="n">queueTime</span> <span class="o">=</span> <span class="n">mJobScheduler</span><span class="o">.</span><span class="na">getQueuedTime</span><span class="o">();</span>
</span><span class='line'>    <span class="kt">long</span> <span class="n">decodeDuration</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">imageUrl</span> <span class="o">=</span> <span class="n">encodedImage</span><span class="o">.</span><span class="na">getEncodedCacheKey</span><span class="o">().</span><span class="na">getUriString</span><span class="o">();</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">isLastAndComplete</span> <span class="o">||</span> <span class="n">isPlaceholder</span> <span class="o">?</span> <span class="n">encodedImage</span><span class="o">.</span><span class="na">getSize</span><span class="o">()</span> <span class="o">:</span> <span class="n">getIntermediateImageEndOffset</span><span class="o">(</span><span class="n">encodedImage</span><span class="o">);</span>
</span><span class='line'>    <span class="n">QualityInfo</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">isLastAndComplete</span> <span class="o">||</span> <span class="n">isPlaceholder</span> <span class="o">?</span> <span class="n">ImmutableQualityInfo</span><span class="o">.</span><span class="na">FULL_QUALITY</span> <span class="o">:</span> <span class="n">getQualityInfo</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mProducerListener</span><span class="o">.</span><span class="na">onProducerStart</span><span class="o">(</span><span class="n">mProducerContext</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">PRODUCER_NAME</span><span class="o">);</span>
</span><span class='line'>    <span class="n">CloseableImage</span> <span class="n">image</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>      <span class="kt">long</span> <span class="n">nowTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>      <span class="n">image</span> <span class="o">=</span> <span class="n">mImageDecoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">encodedImage</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="n">quality</span><span class="o">,</span> <span class="n">mImageDecodeOptions</span><span class="o">);</span>
</span><span class='line'>      <span class="n">decodeDuration</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">nowTime</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">extraMap</span> <span class="o">=</span> <span class="n">getExtraMap</span><span class="o">(</span><span class="n">image</span><span class="o">,</span> <span class="n">imageUrl</span><span class="o">,</span> <span class="n">queueTime</span><span class="o">,</span> <span class="n">decodeDuration</span><span class="o">,</span> <span class="n">quality</span><span class="o">,</span> <span class="n">isLast</span><span class="o">,</span> <span class="n">imageFormatStr</span><span class="o">,</span> <span class="n">encodedImageSize</span><span class="o">,</span> <span class="n">requestedSizeStr</span><span class="o">,</span> <span class="n">sampleSize</span><span class="o">);</span>
</span><span class='line'>      <span class="n">mProducerListener</span><span class="o">.</span><span class="na">onProducerFinishWithFailure</span><span class="o">(</span><span class="n">mProducerContext</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">PRODUCER_NAME</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">extraMap</span><span class="o">);</span>
</span><span class='line'>      <span class="n">handleError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">extraMap</span> <span class="o">=</span> <span class="n">getExtraMap</span><span class="o">(</span><span class="n">image</span><span class="o">,</span> <span class="n">imageUrl</span><span class="o">,</span> <span class="n">queueTime</span><span class="o">,</span> <span class="n">decodeDuration</span><span class="o">,</span> <span class="n">quality</span><span class="o">,</span> <span class="n">isLast</span><span class="o">,</span> <span class="n">imageFormatStr</span><span class="o">,</span> <span class="n">encodedImageSize</span><span class="o">,</span> <span class="n">requestedSizeStr</span><span class="o">,</span> <span class="n">sampleSize</span><span class="o">);</span>
</span><span class='line'>    <span class="n">mProducerListener</span><span class="o">.</span><span class="na">onProducerFinishWithSuccess</span><span class="o">(</span><span class="n">mProducerContext</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">PRODUCER_NAME</span><span class="o">,</span> <span class="n">extraMap</span><span class="o">);</span>
</span><span class='line'>    <span class="n">handleResult</span><span class="o">(</span><span class="n">image</span><span class="o">,</span> <span class="n">status</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">EncodedImage</span><span class="o">.</span><span class="na">closeSafely</span><span class="o">(</span><span class="n">encodedImage</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>因此我们在#doDecoder方法在decode前后插入解码时长计算:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kt">long</span> <span class="n">nowTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>  <span class="n">image</span> <span class="o">=</span> <span class="n">mImageDecoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">encodedImage</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="n">quality</span><span class="o">,</span> <span class="n">mImageDecodeOptions</span><span class="o">);</span>
</span><span class='line'>  <span class="n">decodeDuration</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">nowTime</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>ImageDecoder</h4>

<p><code>DecoderProducer</code> 中是依赖<code>ImageDecoder</code>类，用来将未解码的<code>EncodeImage</code>解码成对应的<code>CloseableImage</code>。<code>ImageDecoder</code>中先判断未解码的图片类型：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">private</span> <span class="kd">final</span> <span class="n">ImageDecoder</span> <span class="n">mDefaultDecoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ImageDecoder</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">CloseableImage</span> <span class="nf">decode</span><span class="o">(</span><span class="n">EncodedImage</span> <span class="n">encodedImage</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">,</span> <span class="n">QualityInfo</span> <span class="n">qualityInfo</span><span class="o">,</span> <span class="n">ImageDecodeOptions</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">ImageFormat</span> <span class="n">imageFormat</span> <span class="o">=</span> <span class="n">encodedImage</span><span class="o">.</span><span class="na">getImageFormat</span><span class="o">();</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">imageFormat</span> <span class="o">==</span> <span class="n">DefaultImageFormats</span><span class="o">.</span><span class="na">JPEG</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">decodeJpeg</span><span class="o">(</span><span class="n">encodedImage</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="n">qualityInfo</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">imageFormat</span> <span class="o">==</span> <span class="n">DefaultImageFormats</span><span class="o">.</span><span class="na">GIF</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">decodeGif</span><span class="o">(</span><span class="n">encodedImage</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="n">qualityInfo</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">imageFormat</span> <span class="o">==</span> <span class="n">DefaultImageFormats</span><span class="o">.</span><span class="na">WEBP_ANIMATED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">decodeAnimatedWebp</span><span class="o">(</span><span class="n">encodedImage</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="n">qualityInfo</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">imageFormat</span> <span class="o">==</span> <span class="n">ImageFormat</span><span class="o">.</span><span class="na">UNKNOWN</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;unknown image format&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="nf">decodeStaticImage</span><span class="o">(</span><span class="n">encodedImage</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h4>ImageFormatChecker</h4>

<p>这个类是根据输入流来确定图片的类型。基本原理是根据头标识去确定类型。根据代码能看出，这里分为几种。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ImageFormat</span> <span class="n">JPEG</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ImageFormat</span><span class="o">(</span><span class="s">&quot;JPEG&quot;</span><span class="o">,</span> <span class="s">&quot;jpeg&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ImageFormat</span> <span class="n">PNG</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ImageFormat</span><span class="o">(</span><span class="s">&quot;PNG&quot;</span><span class="o">,</span> <span class="s">&quot;png&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ImageFormat</span> <span class="n">GIF</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ImageFormat</span><span class="o">(</span><span class="s">&quot;GIF&quot;</span><span class="o">,</span> <span class="s">&quot;gif&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ImageFormat</span> <span class="n">BMP</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ImageFormat</span><span class="o">(</span><span class="s">&quot;BMP&quot;</span><span class="o">,</span> <span class="s">&quot;bmp&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ImageFormat</span> <span class="n">WEBP_SIMPLE</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ImageFormat</span><span class="o">(</span><span class="s">&quot;WEBP_SIMPLE&quot;</span><span class="o">,</span> <span class="s">&quot;webp&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ImageFormat</span> <span class="n">WEBP_LOSSLESS</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ImageFormat</span><span class="o">(</span><span class="s">&quot;WEBP_LOSSLESS&quot;</span><span class="o">,</span> <span class="s">&quot;webp&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ImageFormat</span> <span class="n">WEBP_EXTENDED</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ImageFormat</span><span class="o">(</span><span class="s">&quot;WEBP_EXTENDED&quot;</span><span class="o">,</span> <span class="s">&quot;webp&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ImageFormat</span> <span class="n">WEBP_EXTENDED_WITH_ALPHA</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ImageFormat</span><span class="o">(</span><span class="s">&quot;WEBP_EXTENDED_WITH_ALPHA&quot;</span><span class="o">,</span> <span class="s">&quot;webp&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ImageFormat</span> <span class="n">WEBP_ANIMATED</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ImageFormat</span><span class="o">(</span><span class="s">&quot;WEBP_ANIMATED&quot;</span><span class="o">,</span> <span class="s">&quot;webp&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>本篇我们关心以下几种：
- JPEG
- WEBP_SIMPLE
- GIF
- WEBP_ANIMATED</p>

<p>从是否静态图上来看，为两种：
- 可动 ，用AnimatedImageFactory进行解析
- 不可动，用PlatformDecoder进行解析</p>

<h4>AnimatedImageFactory</h4>

<p>AnimatedImageFactory是一个接口，他的实现类是AnimatedImageFactoryImpl。
在这个类的静态方法块种，通过如下代码 来构造其他依赖包中的对象，这个小技巧我们可以get一下。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="n">AnimatedImageDecoder</span> <span class="nf">loadIfPresent</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">className</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="o">(</span><span class="n">AnimatedImageDecoder</span><span class="o">)</span> <span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">static</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">sGifAnimatedImageDecoder</span> <span class="o">=</span> <span class="n">loadIfPresent</span><span class="o">(</span><span class="s">&quot;com.facebook.animated.gif.GifImage&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">sWebpAnimatedImageDecoder</span> <span class="o">=</span> <span class="n">loadIfPresent</span><span class="o">(</span><span class="s">&quot;com.facebook.animated.webp.WebPImage&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>AnimatedImageDecoder又分别有两个实现：
- <code>WebpImage</code>
- <code>GifImage</code></p>

<p><img src="http://upload-images.jianshu.io/upload_images/76332-9ce98211c5be0f50.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="WebpImage与GifImage" /></p>

<p>解析分为两个步骤：
1. 通过<code>AnimatedImageDecode</code>r解析出AnimatedImage
2. 利用getCloseableImage从<code>AnimatedImage</code>中构造出<code>CloseableAnimatedImage</code>。这是<code>CloseableImage</code>的之类。
getCloseableImage的逻辑如下：
1. 用decodeAllFrames解析出所有帧
2. 用createPreviewBitmap构造预览的bitmap
3. 构造<code>AnimatedImageResult</code>对象
4. 用<code>AnimatedImageResult</code>构造<code>CloseableAnimatedImage</code>对象。</p>

<h4>PlatformDecoder</h4>

<p><code>PlatformDecoder</code>是一个接口，代表不同平台。我们看他的实现类有哪些:</p>

<p><img src="http://upload-images.jianshu.io/upload_images/76332-37a7a0bdcb84bc8f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="PlatformDecoder具体实现" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PlatformDecoder</span> <span class="o">{</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Creates a bitmap from encoded bytes. Supports JPEG but callers should use {@link</span>
</span><span class='line'><span class="cm">   * #decodeJPEGFromEncodedImage} for partial JPEGs.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * @param encodedImage the reference to the encoded image with the reference to the encoded bytes</span>
</span><span class='line'><span class="cm">   * @param bitmapConfig the {@link android.graphics.Bitmap.Config} used to create the decoded</span>
</span><span class='line'><span class="cm">   * Bitmap</span>
</span><span class='line'><span class="cm">   * @return the bitmap</span>
</span><span class='line'><span class="cm">   * @throws TooManyBitmapsException if the pool is full</span>
</span><span class='line'><span class="cm">   * @throws java.lang.OutOfMemoryError if the Bitmap cannot be allocated</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="n">CloseableReference</span><span class="o">&lt;</span><span class="n">Bitmap</span><span class="o">&gt;</span> <span class="nf">decodeFromEncodedImage</span><span class="o">(</span><span class="kd">final</span> <span class="n">EncodedImage</span> <span class="n">encodedImage</span><span class="o">,</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">bitmapConfig</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Creates a bitmap from encoded JPEG bytes. Supports a partial JPEG image.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * @param encodedImage the reference to the encoded image with the reference to the encoded bytes</span>
</span><span class='line'><span class="cm">   * @param bitmapConfig the {@link android.graphics.Bitmap.Config} used to create the decoded</span>
</span><span class='line'><span class="cm">   * Bitmap</span>
</span><span class='line'><span class="cm">   * @param length the number of encoded bytes in the buffer</span>
</span><span class='line'><span class="cm">   * @return the bitmap</span>
</span><span class='line'><span class="cm">   * @throws TooManyBitmapsException if the pool is full</span>
</span><span class='line'><span class="cm">   * @throws java.lang.OutOfMemoryError if the Bitmap cannot be allocated</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="n">CloseableReference</span><span class="o">&lt;</span><span class="n">Bitmap</span><span class="o">&gt;</span> <span class="nf">decodeJPEGFromEncodedImage</span><span class="o">(</span><span class="n">EncodedImage</span> <span class="n">encodedImage</span><span class="o">,</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">Config</span> <span class="n">bitmapConfig</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">getBitmapFactoryOptions</span> <span class="n">获取BitmapFactory</span><span class="o">.</span><span class="na">Options</span>
</span><span class='line'><span class="n">decodeByteArrayAsPurgeable</span> <span class="n">获取bitmap</span>
</span><span class='line'><span class="n">pinBitmap</span> <span class="n">真正的decode</span>
</span></code></pre></td></tr></table></div></figure>


<h1>NetworkFetchProducer</h1>

<p><code>NetworkFetchProducer</code>负责从网络层获取图片流，持有<code>NetworkFetcher</code>的实现类；测试代码中，我们添加了OkHttp3的<code>OkHttpNetworkFetcher</code>作为fetcher；我们关心<code>NetworkFetchProducer</code>中的这个方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleFinalResult</span><span class="o">(</span><span class="n">PooledByteBufferOutputStream</span> <span class="n">pooledOutputStream</span><span class="o">,</span> <span class="n">FetchState</span> <span class="n">fetchState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">extraMap</span> <span class="o">=</span> <span class="n">getExtraMap</span><span class="o">(</span><span class="n">fetchState</span><span class="o">,</span> <span class="n">pooledOutputStream</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span><span class='line'>    <span class="n">ProducerListener</span> <span class="n">listener</span> <span class="o">=</span> <span class="n">fetchState</span><span class="o">.</span><span class="na">getListener</span><span class="o">();</span>
</span><span class='line'>    <span class="n">listener</span><span class="o">.</span><span class="na">onProducerFinishWithSuccess</span><span class="o">(</span><span class="n">fetchState</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">PRODUCER_NAME</span><span class="o">,</span> <span class="n">extraMap</span><span class="o">);</span>
</span><span class='line'>    <span class="n">listener</span><span class="o">.</span><span class="na">onUltimateProducerReached</span><span class="o">(</span><span class="n">fetchState</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">PRODUCER_NAME</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>    <span class="n">notifyConsumer</span><span class="o">(</span><span class="n">pooledOutputStream</span><span class="o">,</span> <span class="n">Consumer</span><span class="o">.</span><span class="na">IS_LAST</span> <span class="o">|</span> <span class="n">fetchState</span><span class="o">.</span><span class="na">getOnNewResultStatusFlags</span><span class="o">(),</span> <span class="n">fetchState</span><span class="o">.</span><span class="na">getResponseBytesRange</span><span class="o">(),</span> <span class="n">fetchState</span><span class="o">.</span><span class="na">getConsumer</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>该方法中<code>FetchState</code>记录了一张图片从服务端响应到IO读取的耗时记录。同样的，也是通过<code>ProducerListener</code>的#onProducerFinishWithSuccess方法回调出去。</p>

<h1>计算decode &amp; fecth的时间</h1>

<p>每个<code>Producer</code>的接口实现，都会持有<code>ProducerContext</code>，其中的<code>ProducerListener</code>会回调<code>Producer</code>各个阶段的事件。我们关心这个方法：</p>

<blockquote><p>/<em>*
* Called when a producer successfully finishes processing current unit of work.
* @param extraMap Additional parameters about the producer. This map is immutable and will
* throw an exception if attempts are made to modify it.
</em>/
void onProducerFinishWithSuccess(String requestId, String producerName, @Nullable Map&lt;String, >String> extraMap);</p></blockquote>

<p>该方法会在<code>Producer</code>结束时回调出来，我们利用Fresco包里的<code>RequestLoggingListener</code>，便可监听到<code>DecoderProducer</code>和<code>NetworkFetchProducer</code>的回调。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
</span><span class='line'>    <span class="n">FLog</span><span class="o">.</span><span class="na">setMinimumLoggingLevel</span><span class="o">(</span><span class="n">FLog</span><span class="o">.</span><span class="na">VERBOSE</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Set</span><span class="o">&lt;</span><span class="n">RequestListener</span><span class="o">&gt;</span> <span class="n">listeners</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;(</span><span class="mi">1</span><span class="o">);</span>
</span><span class='line'>    <span class="n">listeners</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">RequestLoggingListener</span><span class="o">());</span>
</span><span class='line'>    <span class="n">ImagePipelineConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">ImagePipelineConfig</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">setRequestListeners</span><span class="o">(</span><span class="n">listeners</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">setNetworkFetcher</span><span class="o">(</span><span class="k">new</span> <span class="nf">OkHttpNetworkFetcher</span><span class="o">(</span><span class="n">OKHttpFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getOkHttpClient</span><span class="o">()))</span>
</span><span class='line'>        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>    <span class="n">DraweeConfig</span> <span class="n">draweeConfig</span> <span class="o">=</span> <span class="n">DraweeConfig</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setDrawDebugOverlay</span><span class="o">(</span><span class="n">DebugOverlayHelper</span><span class="o">.</span><span class="na">isDebugOverlayEnabled</span><span class="o">(</span><span class="k">this</span><span class="o">)).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Fresco</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">config</span><span class="o">,</span> <span class="n">draweeConfig</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Fresco</span><span class="o">.</span><span class="na">getImagePipeline</span><span class="o">().</span><span class="na">clearDiskCaches</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们通过在Fresco初始化Builder中加入<code>RequestLoggingListener</code>，并改造<code>RequestLoggingListener</code>的onProducerFinishWithSuccess方法:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">onProducerFinishWithSuccess</span><span class="o">(</span><span class="n">String</span> <span class="n">requestId</span><span class="o">,</span> <span class="n">String</span> <span class="n">producerName</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">extraMap</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">FLog</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="n">FLog</span><span class="o">.</span><span class="na">VERBOSE</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Pair</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">mapKey</span> <span class="o">=</span> <span class="n">Pair</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">requestId</span><span class="o">,</span> <span class="n">producerName</span><span class="o">);</span>
</span><span class='line'>      <span class="n">Long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">mProducerStartTimeMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">mapKey</span><span class="o">);</span>
</span><span class='line'>      <span class="kt">long</span> <span class="n">currentTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="o">();</span>
</span><span class='line'>      <span class="kt">long</span> <span class="n">producerDuration</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span><span class='line'>      <span class="n">FLog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;time %d: onProducerFinishWithSuccess: &quot;</span> <span class="o">+</span> <span class="s">&quot;{requestId: %s, producer: %s, elapsedTime: %d ms, extraMap: %s}&quot;</span><span class="o">,</span> <span class="n">currentTime</span><span class="o">,</span> <span class="n">requestId</span><span class="o">,</span> <span class="n">producerName</span><span class="o">,</span> <span class="n">producerDuration</span> <span class="o">=</span> <span class="n">getElapsedTime</span><span class="o">(</span><span class="n">startTime</span><span class="o">,</span> <span class="n">currentTime</span><span class="o">),</span> <span class="n">extraMap</span><span class="o">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">sOnProducer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">sOnProducer</span><span class="o">.</span><span class="na">onProducer</span><span class="o">(</span><span class="n">producerDuration</span><span class="o">,</span> <span class="n">extraMap</span><span class="o">,</span> <span class="n">producerName</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过将Producer的信息回调给外面，至此我们就拿到了每一个Producer的回调信息，通过producerName的过滤就可以拿到关心的信息，这里我们关心<code>DecoderProducer</code>和<code>NetworkFetchProducer</code>的信息。</p>

<h3>decode时间计算</h3>

<p>在<code>DecoderProducer</code>的doDecode方法中插入:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kt">long</span> <span class="n">nowTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'> <span class="n">image</span> <span class="o">=</span> <span class="n">mImageDecoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">encodedImage</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="n">quality</span><span class="o">,</span> <span class="n">mImageDecodeOptions</span><span class="o">);</span>
</span><span class='line'> <span class="n">decodeDuration</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">nowTime</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>decodeDuration放入onProducerFinishWithSuccess的extraMap当中</p>

<h3>network fecther时间计算</h3>

<p><code>OkHttpNetworkFetcher</code>中定义着几个常量值：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">QUEUE_TIME</span> <span class="o">=</span> <span class="s">&quot;resp_time&quot;</span><span class="o">;</span> <span class="c1">//修改为响应时间</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FETCH_TIME</span> <span class="o">=</span> <span class="s">&quot;fetch_time&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TOTAL_TIME</span> <span class="o">=</span> <span class="s">&quot;total_time&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">IMAGE_SIZE</span> <span class="o">=</span> <span class="s">&quot;image_size&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">IMAGE_URL</span> <span class="o">=</span> <span class="s">&quot;image_url&quot;</span><span class="o">;</span> <span class="c1">//新增</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>QUEUE_TIME</code>为请求丢入请求线程池到最后请求成功响应的时间</li>
<li><code>FETCH_TIME</code>为从response读完IO流的时间</li>
<li><code>IMAGE_SIZE</code>为response header中的content-length，即图片大小</li>
</ul>


<p>这些数据都最终会被丢入extraMap，回调给外面。</p>

<h1>数据对比</h1>

<h2>jpg&amp;webp指标对比:</h2>

<div align=center>
<img src="http://upload-images.jianshu.io/upload_images/76332-f960ec0cb0bed228.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" width="400" height="400" alt="jpg webp指标对比"/>
</div>


<table>
<thead>
<tr>
<th style="text-align:center;">格式</th>
<th style="text-align:center;">图片数</th>
<th style="text-align:center;">大小</th>
<th style="text-align:left;">响应时间</th>
<th style="text-align:center;">下载时间</th>
<th style="text-align:center;">解码时间</th>
<th style="text-align:center;">总用时</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">jpg</td>
<td style="text-align:center;">100</td>
<td style="text-align:center;">33497748B / 31.9MB</td>
<td style="text-align:left;">3384ms</td>
<td style="text-align:center;">5582ms</td>
<td style="text-align:center;">7225ms</td>
<td style="text-align:center;">16191ms</td>
</tr>
<tr>
<td style="text-align:center;">webp</td>
<td style="text-align:center;">100</td>
<td style="text-align:center;">11127628B / 10.6MB </td>
<td style="text-align:left;">3388ms</td>
<td style="text-align:center;">2552ms</td>
<td style="text-align:center;">9806ms</td>
<td style="text-align:center;">15746ms</td>
</tr>
</tbody>
</table>


<p>以上数据经过几轮测试，都接近这个数据对比。 图片源来自项目线上的图片，图片接口来自公司CND接口，使用相同quality参数，带同一张图片的不同格式参数。解码总时间大概是JPG:WEBP = 1 : 1.3左右，接近官方的1.5倍性能差距。总大小上，webp几乎只有jpg的1/3，远超超官方的30%，这个估计是大多数jpg没有经过压缩就直接上传了。下载时间基本上与size成正比。</p>

<p><a href="http://p1.music.126.net/6OARlbfxOysQJU5iZ8WKSA==/18769762999688243.jpg?imageView=1&amp;type=webp&amp;quality=100">http://p1.music.126.net/6OARlbfxOysQJU5iZ8WKSA==/18769762999688243.jpg?imageView=1&amp;type=webp&amp;quality=100</a></p>

<p><a href="http://p1.music.126.net/6OARlbfxOysQJU5iZ8WKSA==/18769762999688243.jpg?imageView=1&amp;quality=100">http://p1.music.126.net/6OARlbfxOysQJU5iZ8WKSA==/18769762999688243.jpg?imageView=1&amp;quality=100</a></p>

<h2>gif&amp;anim-webp指标对比:</h2>

<div align=center>
<img src="http://upload-images.jianshu.io/upload_images/76332-114e6bf70693178d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" width="400" height="400" alt="gif&anim-webp指标对比"/>
</div>


<table>
<thead>
<tr>
<th style="text-align:center;">格式</th>
<th style="text-align:center;">图片数</th>
<th style="text-align:center;">大小</th>
<th style="text-align:left;">响应时间</th>
<th style="text-align:center;">下载时间</th>
<th style="text-align:center;">解码时间</th>
<th style="text-align:center;">总用时</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">gif</td>
<td style="text-align:center;">85</td>
<td style="text-align:center;">66343142B / 63.26MB</td>
<td style="text-align:left;">2597ms</td>
<td style="text-align:center;">6052ms</td>
<td style="text-align:center;">272ms</td>
<td style="text-align:center;">8921ms</td>
</tr>
<tr>
<td style="text-align:center;">anim-webp</td>
<td style="text-align:center;">85</td>
<td style="text-align:center;">20342068B / 19.39MB</td>
<td style="text-align:left;">2687ms</td>
<td style="text-align:center;">3809ms</td>
<td style="text-align:center;">240ms</td>
<td style="text-align:center;">6736ms</td>
</tr>
</tbody>
</table>


<p>同样地, 分别取了同一张GIF图片的，原始版本与WEBP版本来对比。</p>

<p><a href="http://p1.music.126.net/rhGo28bJP19-T0xmtpg6jw==/19244752021149272.jpg">http://p1.music.126.net/rhGo28bJP19-T0xmtpg6jw==/19244752021149272.jpg</a>
<a href="http://p1.music.126.net/rhGo28bJP19-T0xmtpg6jw==/19244752021149272.jpg?imageView=1&amp;type=webp&amp;tostatic=0">http://p1.music.126.net/rhGo28bJP19-T0xmtpg6jw==/19244752021149272.jpg?imageView=1&amp;type=webp&amp;tostatic=0</a></p>

<h2>size压缩对比也接近1：3；另外这里的解码时间是不准确的，因为webp与gif在fresco中都是<code>AnimatedImage</code>，他们的decode调的是nativeCreateFromNativeMemory方法，这个方法返回是对应的<code>WebPImage</code> 与<code>GifImage</code>对象，表中的解码时间也是构建这个对象的耗时；动图渲染时，主要调用的是<code>AnimatedDrawableBackendImpl</code>中renderFrame方法。但我们可以粗略认为，每一帧的渲染耗时对比，接近jpg与webp的耗时；因为gif与anim-webp分别是由一帧一帧的jpg与webp组成。</h2>

<h1>总结</h1>

<h2>webp与jpg相比，包括anim-webp与gif， 在相同的图片质量，图片大小上，webp有着巨大的优势，解码速度毫秒级的差距也完全在接收范围内， 而图片大小最终转化为带宽、存储空间、加载速度上的优势。因此在有条件的情况，app中完全可以用webp来替代jpg格式以提升加载速度、降低存储空间、节省带宽费用。另外在android上，使用fresco作为图片库，可以几乎无成本的接入webp。</h2>

<h1>参考</h1>

<p>webp图片介绍 <a href="http://changety.github.io/blog/2016/01/31/webp-research/">http://changety.github.io/blog/2016/01/31/webp-research/</a></p>

<p>webp常见问题 <a href="https://developers.google.com/speed/webp/faq">https://developers.google.com/speed/webp/faq</a></p>

<p>fresco decode过程 <a href="https://guolei1130.github.io/2016/12/13/fresco%E5%9B%BE%E7%89%87decode%E7%9A%84%E5%A4%A7%E4%BD%93%E6%B5%81%E7%A8%8B/">https://guolei1130.github.io/2016/12/13/fresco%E5%9B%BE%E7%89%87decode%E7%9A%84%E5%A4%A7%E4%BD%93%E6%B5%81%E7%A8%8B/</a></p>
</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style addthis_16x16_style">
	
	<a class="addthis_button_sinaweibo"></a>
	
	
	
	<a class="addthis_button_twitter"></a>
	
	
	
	<a class="addthis_button_compact"></a>
	<a class="addthis_counter addthis_bubble_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/300/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2017

    BianYuting


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'ibiandev';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://changety.github.io/blog/2017/06/20/fresco-jpg-webp-decode/';
        var disqus_url = 'http://changety.github.io/blog/2017/06/20/fresco-jpg-webp-decode/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





		</div>
	</div>
</body>
</html>
